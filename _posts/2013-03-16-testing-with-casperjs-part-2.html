---
layout: post
status: publish
published: true
title: Testing with CasperJS - Part 2
author:
  display_name: vgaltesc
  login: vgaltesc
  email: vincentredrum@gmail.com
  url: ''
author_login: vgaltesc
author_email: vincentredrum@gmail.com
wordpress_id: 50
wordpress_url: http://vgaltes.com/?p=50
date: '2013-03-16 18:32:06 +0000'
date_gmt: '2013-03-16 18:32:06 +0000'
categories:
- Code
tags:
- javascript
- casperjs
- web
- testing
comments:
- id: 30884
  author: Ilya
  author_email: alvesker86@gmail.com
  author_url: ''
  date: '2014-11-04 06:42:08 +0000'
  date_gmt: '2014-11-04 05:42:08 +0000'
  content: "Hello,\r\n\r\nI have tried this method to test if resources are loaded.
    So in the script I have\r\n\r\n   casper.on('resource.received', function(resource)
    {        //checks if images are loaded\r\n          var status = resource.status;\r\n
    \         if(status &gt;= 400) {\r\n             casper.log('Resource ' + resource.url
    + ' failed to load (' + status + ')', 'error');\r\n             resourceErrors.push({\r\n
    \                url: resource.url,\r\n                 status: resource.status\r\n
    \            });\r\n          }\r\n    });\r\n\r\n\r\nIt works most of times,
    but not always. Sometimes I can see that the page is correctly loaded in browser,
    but when I run script I get error:\r\n\r\nFAIL ReferenceError: Can't find variable:
    resourceErrors\r\n#    type: uncaughtError\r\n#    file: ./test_auto_smoke2_new.js:120\r\n#
    \   error: Can't find variable: resourceErrors\r\n#           ReferenceError:
    Can't find variable: resourceErrors\r\n#               at ./test_auto_smoke2_new.js:120\r\n#
    \              at emit (/home/ilya/test_automation/casperjs/modules/events.js:80)\r\n#
    \              at onResourceReceived (/home/ilya/test_automation/casperjs/modules/casper.js:2594)\r\n#
    \   stack: not provided\r\n\r\n\r\nAny ideas what might cause this?"
- id: 32085
  author: vgaltesc
  author_email: vincentredrum@gmail.com
  author_url: ''
  date: '2014-12-08 22:20:22 +0000'
  date_gmt: '2014-12-08 21:20:22 +0000'
  content: "It seems that the variable resourceErrors is not accessible. Have you
    declared the variable in a place where is accessible by all the functions trying
    to use it?\r\n\r\nThe other question is, have you checked with the developers
    tools of your browser that you are getting an 4xx error?\r\n\r\nThanks,"
- id: 32112
  author: drumbron
  author_email: drumbron@icloud.com
  author_url: ''
  date: '2015-12-25 13:28:00 +0000'
  date_gmt: '2015-12-25 13:28:00 +0000'
  content: |-
    Last example didn't work for me. Output:

    Error:    SyntaxError: Parse error
    FAIL TypeError: 'undefined' is not an object (evaluating 'trace[0].file')
---
<p>In our <a title="Testing with CasperJS – Part 1" href="http://vgaltes.com/index.php/2013/03/14/testing-with-casperjs-part-1/" target="_blank">last post</a> we have seen how to install <a title="CasperJS" href="http://casperjs.org" target="_blank">CasperJS</a> and how to make a very simple script. In this post we will make more interesting stuff.</p>
<p>In this tutorial we will see how to catch any error in our web page, whether it be the lack of an image or script or an error in javascript code.</p>
<p>So, lets start forcing these errors. Go to your _layout.cshtml page (or other page if you are not using <a title="ASP.NET" href="http://www.asp.net/" target="_blank">ASP.NET MVC</a>) and add this line to try to load a non existing script.</p>
<pre class="brush:php">&lt;script type="text/javascript" src="js/fake.js"&gt;&lt;/script&gt;</pre>
<p>In the same page, find where the logo link is created</p>
<pre class="brush:php">&lt;p class="site-title"&gt;@Html.ActionLink("your logo here", "Index", "Home")&lt;/p&gt;</pre>
<p>and change it for a non existing image, like this:</p>
<pre class="brush:php">&lt;a href="http://localhost:8000"&gt;
    &lt;img src="~/Content/Images/logo.png"&gt;&lt;/img&gt;
&lt;/a&gt;</pre>
<p>Now, go to the site.css file, and add this line to .body</p>
<pre class="brush:css">background: url("../Images/noExists.png") no-repeat;</pre>
<p>And finally, create a script in Scripts folder with this content and name it error.js</p>
<pre class="brush:javascript">function throwError() {
    throw new Error();
}

throwError();</pre>
<p>And add it at the end of your _layout.cshtml page</p>
<pre class="brush:php">&lt;script src="~/Scripts/error.js"&gt;&lt;/script&gt;</pre>
<p>If we load the page and take a look at the network tab of the developer tools we could see the errors on resource loading.</p>
<p>[caption id="attachment_51" align="alignnone" width="1239"]<a href="http://vgaltes.com/wp-content/uploads/2013/03/errorLoadingResources.png"><img class="size-full wp-image-51" alt="error loading resourcees" src="http://vgaltes.com/wp-content/uploads/2013/03/errorLoadingResources.png" width="1239" height="404" /></a> error loading resourcees[/caption]</p>
<p>And taking a look at the errors tab, we could see more errors</p>
<p>[caption id="attachment_52" align="alignnone" width="669"]<a href="http://vgaltes.com/wp-content/uploads/2013/03/errorLoadingJsResources.jpg"><img class="size-full wp-image-52" alt="error loading resources" src="http://vgaltes.com/wp-content/uploads/2013/03/errorLoadingJsResources.jpg" width="669" height="75" /></a> error loading resources[/caption]</p>
<p>So, let's try to catch these errors.</p>
<p>Put this code between the casper.start call and the casper.run call.</p>
<pre class="brush:javascript">casper.start('http://localhost:8000/', function () {
    if (this.resourceExists('fake.js')) {
        this.echo('fake.js is downloaded');
    } else {
        this.echo('fake.js is not downloaded');
    }

    if (this.resourceExists('error.js')) {
        this.echo('error.js is downloaded');
    } else {
        this.echo('error.js is not downloaded');
    }
});</pre>
<p>With this code we are asking CasperJS whether fake.js and error.js are downloaded. As a result we should have this output:</p>
<p>[caption id="attachment_56" align="alignnone" width="675"]<a href="http://vgaltes.com/wp-content/uploads/2013/03/result1.png"><img class="size-full wp-image-56" alt="result" src="http://vgaltes.com/wp-content/uploads/2013/03/result1.png" width="675" height="102" /></a> result[/caption]</p>
<p>That's great! Error.js exists in our project but fake.js don't. So the result is the expected.</p>
<p>Could we do the same with the images? Yes, of course. Replace the previous code with this one:</p>
<pre class="brush:javascript">casper.start('http://localhost:8000/', function () {
    if (this.resourceExists('logo.png')) {
        this.echo('logo.js is downloaded');
    } else {
        this.echo('logo.js is not downloaded');
    }
});</pre>
<p>And we should have this output:</p>
<p>[caption id="attachment_57" align="alignnone" width="676"]<a href="http://vgaltes.com/wp-content/uploads/2013/03/result2.png"><img class="size-full wp-image-57" alt="result" src="http://vgaltes.com/wp-content/uploads/2013/03/result2.png" width="676" height="89" /></a> result[/caption]</p>
<p>Ok, that's great but it's not reasonable to have all the resources in our web hardcoded in the script. Let's try to generalize a little bit more. Let's start with the scripts:</p>
<pre class="brush:javascript">var scriptsArray = [];

function getScripts() {
    var scripts = document.querySelectorAll('script[src]');
    return Array.prototype.map.call(scripts, function(e) {
        return e.getAttribute('src');
    });
};

casper.start('http://localhost:8000/', function () {
    scriptsArray = this.evaluate(getScripts);
    var self = this;
    scriptsArray.forEach(function(item) {
        if (self.resourceExists(item)) {
            self.echo(item + ' loaded');
        } else {
            self.echo(item + ' not loaded', 'ERROR');
        }
    });
});</pre>
<p>In this script we are retrieving all the page's scripts using a css selector. To do this we have to use the evaluate function. With the array of scripts we could call the resourceExists function to know whether the resource is loaded or not.</p>
<p>Executing the script we should have this result:</p>
<p>[caption id="attachment_58" align="alignnone" width="675"]<a href="http://vgaltes.com/wp-content/uploads/2013/03/result3.png"><img class="size-full wp-image-58" alt="result" src="http://vgaltes.com/wp-content/uploads/2013/03/result3.png" width="675" height="122" /></a> result[/caption]</p>
<p>And yes, we could do the same for the images, changing the css selector a little bit:</p>
<pre class="brush:javascript">var imagesArray = [];

function getImages() {
    var scripts = document.querySelectorAll('img[src]');
    return Array.prototype.map.call(scripts, function (e) {
        return e.getAttribute('src');
    });
};

casper.start('http://localhost:8000/', function () {
    imagesArray = this.evaluate(getImages);
    var self = this;
    imagesArray.forEach(function (item) {
        if (self.resourceExists(item)) {
            self.echo(item + ' loaded');
        } else {
            var message = item + ' not loaded';
            self.echo(message, 'ERROR');
        }
    });
});</pre>
<p>And the output:</p>
<p>[caption id="attachment_59" align="alignnone" width="675"]<a href="http://vgaltes.com/wp-content/uploads/2013/03/result4.png"><img class="size-full wp-image-59" alt="result" src="http://vgaltes.com/wp-content/uploads/2013/03/result4.png" width="675" height="88" /></a> result[/caption]</p>
<p>Could be a good idea to take a snapshot if an image is not loaded. We could do this using the capture function:</p>
<pre class="brush:javascript">casper.start('http://localhost:8000/', function () {
    imagesArray = this.evaluate(getImages);
    var self = this;
    var isThereAnError = false;
    imagesArray.forEach(function (item) {
        if (self.resourceExists(item)) {
            self.echo(item + ' loaded');
        } else {
            var message = item + ' not loaded';
            self.echo(message, 'ERROR');
            self.isThereAnError = true;
        }
    });

    if (this.isThereAnError == true) {
        casper.capture('noimages.png');
    }
});</pre>
<p>The output will be the same as before, but if you take a look at the script folder you will see that now there is an image in it:</p>
<p>[caption id="attachment_61" align="alignnone" width="826"]<a href="http://vgaltes.com/wp-content/uploads/2013/03/noimages.png"><img class="size-full wp-image-61" alt="no images" src="http://vgaltes.com/wp-content/uploads/2013/03/noimages.png" width="826" height="502" /></a> no images[/caption]</p>
<p>And if you open the image, you will see the web page rendered.</p>
<p>[caption id="attachment_62" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2013/03/noimagesRendered.png"><img class="size-full wp-image-62" alt="page rendered" src="http://vgaltes.com/wp-content/uploads/2013/03/noimagesRendered.png" width="1024" height="768" /></a> page rendered[/caption]</p>
<p>But we have a problem. We don't have any notices about the image set in body's background that doesn't exist. We have to try another approach to catch this error. It would be great to catch any 404 error on resources loading, and CasperJS allows us to do.</p>
<p>Change the previous function by this one:</p>
<pre class="brush:javascript">casper.on("resource.received", function(request) {
    if (request.status === 404) {
        this.echo('Resource Not Found:' + request.url);
    }
});

casper.start('http://localhost:8000/', function () {});</pre>
<p>Now, we are subscribing to the resource.received event, and looking at the status code we could know whether the resource is loaded or not.</p>
<p>If we take a look at the output we could see that an error is shown for the image inside the css too.</p>
<p>[caption id="attachment_63" align="alignnone" width="675"]<a href="http://vgaltes.com/wp-content/uploads/2013/03/result5.png"><img class="size-full wp-image-63" alt="catching 404 errors" src="http://vgaltes.com/wp-content/uploads/2013/03/result5.png" width="675" height="147" /></a> catching 404 errors[/caption]</p>
<p>&nbsp;</p>
<p>Ok, now we have a generic way to be aware of errors when loading resources. Now we need to know when a javascript error happens. To do that we are going to use the events too, but now we are going to subscribe to page.error event:</p>
<pre class="brush:javascript">casper.on("page.error", function (msg, trace) {
    this.echo("Error:    " + msg, "ERROR");
    this.echo("file:     " + trace[0].file, "WARNING");
    this.echo("line:     " + trace[0].line, "WARNING");
    this.echo("function: " + trace[0]["function"], "WARNING");
});</pre>
<p>And we obtain as a result</p>
<p>[caption id="attachment_64" align="alignnone" width="675"]<a href="http://vgaltes.com/wp-content/uploads/2013/03/result6.png"><img class="size-full wp-image-64" alt="on error" src="http://vgaltes.com/wp-content/uploads/2013/03/result6.png" width="675" height="123" /></a> on error[/caption]</p>
<p>So, we have a generic way to obtain the errors loading resources or executing javascript of our web page. In upcoming tutorials we will explore more capabilities of CasperJs.</p>
<p>See you soon!</p>
