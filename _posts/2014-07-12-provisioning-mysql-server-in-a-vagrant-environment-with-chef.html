---
layout: post
status: publish
published: true
title: Provisioning MySQL server in a Vagrant environment with Chef
author:
  display_name: vgaltesc
  login: vgaltesc
  email: vincentredrum@gmail.com
  url: ''
author_login: vgaltesc
author_email: vincentredrum@gmail.com
wordpress_id: 169
wordpress_url: http://vgaltes.com/?p=169
date: '2014-07-12 12:21:00 +0100'
date_gmt: '2014-07-12 12:21:00 +0100'
categories:
- DevOps
tags:
- Continuous Deployment
- Chef
- Vagrant
comments:
- id: 26145
  author: Philip
  author_email: djheru@gmail.com
  author_url: ''
  date: '2014-09-07 04:29:24 +0100'
  date_gmt: '2014-09-07 03:29:24 +0100'
  content: "Unfortunately, I get the following error: \r\n<blockquote>\r\n==&gt; default:
    Recipe Compile Error in /tmp/vagrant-chef-3/chef-solo-1/cookbooks/mysql/libraries/provider_mysql_service_smartos.rb\r\n==&gt;
    default: ================================================================================\r\n==&gt;
    default: LoadError\r\n==&gt; default: ---------\r\n==&gt; default: no such file
    to load -- chef/provider/lwrp_base\r\n==&gt; default: Cookbook Trace:\r\n==&gt;
    default: ---------------\r\n==&gt; default:   /tmp/vagrant-chef-3/chef-solo-1/cookbooks/mysql/libraries/provider_mysql_service_smartos.rb:1\r\n==&gt;
    default: Relevant File Content:\r\n==&gt; default: ----------------------\r\n==&gt;
    default: /tmp/vagrant-chef-3/chef-solo-1/cookbooks/mysql/libraries/provider_mysql_service_smartos.rb:\r\n==&gt;
    default: \r\n==&gt; default:   1:  require 'chef/provider/lwrp_base'\r\n==&gt;
    default:   2:  require 'shellwords'\r\n==&gt; default:   3:  require_relative
    'helpers_smartos'\r\n==&gt; default:   4:  \r\n==&gt; default:   5:  class Chef\r\n==&gt;
    default:   6:    class Provider\r\n==&gt; default:   7:      class MysqlService\r\n==&gt;
    default:   8:        class Smartos  default:   9:          use_inline_resources
    if defined?(use_inline_resources)\r\n==&gt; default: \r\n==&gt; default: [2014-09-07T03:27:17+00:00]
    ERROR: Running exception handlers\r\n==&gt; default: [2014-09-07T03:27:17+00:00]
    ERROR: Exception handlers complete\r\n==&gt; default: [2014-09-07T03:27:17+00:00]
    FATAL: Stacktrace dumped to /var/chef/cache/chef-stacktrace.out\r\n==&gt; default:
    [2014-09-07T03:27:17+00:00] FATAL: LoadError: no such file to load -- chef/provider/lwrp_base\r\n</blockquote>"
- id: 32084
  author: vgaltesc
  author_email: vincentredrum@gmail.com
  author_url: ''
  date: '2014-12-08 22:16:38 +0000'
  date_gmt: '2014-12-08 21:16:38 +0000'
  content: "Hi,\r\n\r\nit seems an error in the recipe. How are you trying to install
    mysql? Have you tried the cookbook used in the article?"
- id: 32093
  author: Jon Thomas
  author_email: jon@analyticl.com
  author_url: http://www.analyticl.com/
  date: '2015-03-18 03:00:00 +0000'
  date_gmt: '2015-03-18 03:00:00 +0000'
  content: |-
    Whoops, sorry guys. This isn't even related to this article. I had another article open over here: https://gorails.com/guides/using-vagrant-for-rails-development

    It appears both articles have Disqus. I found this article while searching for the answer, but my problem has nothing to do with this article. Just posted under the wrong Disqus! :-o

    However... if you have any input, I'm all ears. This is my first time using Chef, so I may be in over my head.

    I'm going to go paste that under the correct article now.... [face -&gt; palm]
- id: 32094
  author: Jon Thomas
  author_email: jon@analyticl.com
  author_url: http://www.analyticl.com/
  date: '2015-03-18 03:19:00 +0000'
  date_gmt: '2015-03-18 03:19:00 +0000'
  content: Actually, please feel free to delete that comment if you don't want your
    users getting confused.
---
<p>Hi,</p>
<p>in this article I will show you how can you provision a <a title="MySQLS" href="www.mysql.com" target="_blank">MySQL</a> server with <a title="Chef" href="http://www.getchef.com/chef/" target="_blank">Chef</a> in a <a title="Vagrant" href="http://www.vagrantup.com/" target="_blank">Vagrant</a> environment. The <a title="Vagrant" href="http://vagrantup.com" target="_blank">Vagrant</a> environment will be an <a title="Ubuntu" href="http://www.ubuntu.com/" target="_blank">Ubuntu</a> virtual machine. I will do this tutorial in a OSX machine. If you want to make it in a Windows environment, the commands could be slightly different.</p>
<p>First of all you will need to install Vagrant, Chef and VirtualBox. Please, refer to their web sites to know how to do it.</p>
<p>The first step is create a directory for our environment. Let's call it UbuntuMySQL. We will make two directories inside it: environment and share.</p>
<pre>mkdir -p UbuntuMySQL/{environment/,share/}</pre>
<p>Initialize a git repository inside your new folder.</p>
<pre>cd UbuntuMySQL
git init</pre>
<p>Go to your environment folder and initialize Vagrant</p>
<pre>cd environment
vagrant init</pre>
<p>Now you have a file called Vagrantfile whit sample data. Take a look at it to imagine how many things you can configure. Erase all the content and copy these lines.</p>
<p>[caption id="attachment_170" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef1.png"><img class="wp-image-170 size-large" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef1-1024x372.png" alt="First Vagrantfile" width="1024" height="372" /></a> First Vagrantfile[/caption]</p>
<p>(The url of config.vm.box_url is http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_ubuntu-14.04_chef-provisionerless.box)</p>
<p>In this lines we are telling Vagrant that we want him to download this virtual maxine, create a private network and that we want to sync our ../share folder with the /share folder in the virtual machine.</p>
<p>Now we are ready to start our virtual machine. Just write vagrant up in your shell. If it's the first time you make this, have a book near you because vagrant will download the virtual machine and, depending on your broadband connection, could be time consuming.</p>
<p>The result of the operation is something similar to this.</p>
<p>[caption id="attachment_171" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef2.png"><img class="wp-image-171 size-large" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef2-1024x659.png" alt="virtual machine up" width="1024" height="659" /></a> virtual machine up[/caption]</p>
<p>Now, you could write vagrant ssh and access your virtual machine. As it's configured in the Vagrantfile file, the user used to connect will be "vagrant".</p>
<p>[caption id="attachment_172" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef3.png"><img class="wp-image-172 size-large" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef3-1024x162.png" alt="vagrant ssh" width="1024" height="162" /></a> vagrant ssh[/caption]</p>
<p>Ok, we have a brand new Ubuntu virtual machine but we want it to install a MySQL server. Do I have to do it manually? The answer is NO, you could use chef to do the job for you.</p>
<p>Chef uses cookbooks to know what to do to install applications (or whatever you want to do with Chef). So, seems logic that we need to have a MySQL cookbook to be able to install MySQL. Do I have to write it? Maybe, but there are loads of cookbooks already written. You could find them at <a title="https://supermarket.getchef.com/cookbooks" href="https://supermarket.getchef.com/cookbooks" target="_blank">https://supermarket.getchef.com/cookbooks</a>. Let's download the MySQL cookbook to our repository. To do that write this command in your shell in the virtual machine root folder:</p>
<pre class="p1">git submodule add https://github.com/opscode-cookbooks/mysql.git environment/cookbooks/mysql</pre>
<p>Doing this, we will clone the repository in environment/cookbooks/mysql folder.</p>
<p>If you take a look at recipes folder inside that folder, you could see more than one recipe:</p>
<p>[caption id="attachment_173" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef4.png"><img class="wp-image-173 size-large" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef4-1024x267.png" alt="MySQL recipes" width="1024" height="267" /></a> MySQL recipes[/caption]</p>
<p>The one we want to install is server.rb.</p>
<p>Let's edit our Vagrantfile to tell Vagrant to install MySQL using Chef.</p>
<p><a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef5.png"><img class="alignnone wp-image-174 size-large" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef5-1024x791.png" alt="VagrantChef5" width="1024" height="791" /></a></p>
<p>Stop the virtual machine using "vagrant halt" and run one more time "vagrant up".</p>
<p>Ops! We have an error!</p>
<p>[caption id="attachment_175" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef6.png"><img class="wp-image-175 size-large" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef6-1024x200.png" alt="Error no Chef" width="1024" height="200" /></a> Error no Chef[/caption]</p>
<p>It seems that Chef isn't installed in the virtual machine. To do that we can use <a title="Vagrant Omnibus" href="https://github.com/schisamo/vagrant-omnibus" target="_blank">Vagrant Omnibus</a> to help us. Install it and write in your shell</p>
<pre>vagrant plugin install vagrant-omnibus</pre>
<p style="color: #333333;">Now, we can change our Vagrantfile to install chef in the virtual machine.</p>
<p>[caption id="attachment_176" align="alignnone" width="780"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/Vagrantchef7.png"><img class="wp-image-176 size-full" src="http://vgaltes.com/wp-content/uploads/2014/07/Vagrantchef7.png" alt="Install chef" width="780" height="94" /></a> Install chef[/caption]</p>
<p style="color: #333333;">Let's try to provision our virtual machine. Write this in your shell:</p>
<pre style="color: #333333;">vagrant provision</pre>
<p style="color: #333333;">Ops! Another error!</p>
<p>[caption id="attachment_177" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef8.png"><img class="wp-image-177 size-large" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef8-1024x204.png" alt="No yum-mysql-cummunity" width="1024" height="204" /></a> No yum-mysql-cummunity[/caption]</p>
<p style="color: #333333;">It seems that we need another cookbook, in this case yum-mysql-cummunity. Let's download it:</p>
<pre class="p1">git submodule add https://github.com/opscode-cookbooks/yum-mysql-community.git environment/cookbooks/yum-mysql-community</pre>
<p class="p1">Try to provision one more time and... oh no, another error!</p>
<p>[caption id="attachment_178" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef9.png"><img class="wp-image-178 size-large" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef9-1024x230.png" alt="No yum" width="1024" height="230" /></a> No yum[/caption]</p>
<p style="color: #333333;">We need to download another cookbook. Let's do it:</p>
<pre class="p1">git submodule add https://github.com/opscode-cookbooks/yum.git environment/cookbooks/yum</pre>
<p class="p1">And try to provision one more time. Oh, no errors! Looks promising!</p>
<p class="p1">To ensure MySQL is installed, enter in the virtual machine</p>
<pre class="p1">vagrant ssh</pre>
<p class="p1">and try to access to the mysql server:</p>
<p>[caption id="attachment_179" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef10.png"><img class="wp-image-179 size-large" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef10-1024x403.png" alt="MySQL installed" width="1024" height="403" /></a> MySQL installed[/caption]</p>
<p class="p1">Great! And now, let's try to connect to that server from our computer. Open MySQLWorkbench and connect to the server:</p>
<p>[caption id="attachment_180" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantCheff11.png"><img class="wp-image-180 size-large" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantCheff11-1024x670.png" alt="Connecting from host" width="1024" height="670" /></a> Connecting from host[/caption]</p>
<p>[caption id="attachment_181" align="alignnone" width="728"]<a href="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef12.png"><img class="wp-image-181 size-full" src="http://vgaltes.com/wp-content/uploads/2014/07/VagrantChef12.png" alt="Connected" width="728" height="210" /></a> Connected[/caption]</p>
<p class="p1">That's great! We've installed a virtual machine (with no gui) in our machine, installed a MySQL server and connected to it. The greatest thing is that this steps are repeatable. We could upload this files to our Git server, and another workmate could pull them, execute vagrant up and have exactly the same environment we have.</p>
<p class="p1">Thanks for reading, see you soon!</p>
