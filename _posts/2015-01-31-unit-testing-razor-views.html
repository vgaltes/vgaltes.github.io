---
layout: post
status: publish
published: true
title: Unit testing razor views
author:
  display_name: vgaltesc
  login: vgaltesc
  email: vincentredrum@gmail.com
  url: ''
author_login: vgaltesc
author_email: vincentredrum@gmail.com
wordpress_id: 218
wordpress_url: http://vgaltes.com/?p=218
date: '2015-01-31 16:29:34 +0000'
date_gmt: '2015-01-31 15:29:34 +0000'
categories:
- Testing
- Asp.Net
tags: []
comments: []
---
<p>If you are developing a web site using <a title="ASP.NET" href="http://www.asp.net/" target="_blank">ASP.NET MVC</a> it's possible that you are using razor in your views. And it's possible that you have some presentation logic in that views. This code is hard to test. We love testing our code, so probably you'll end up coding some <a title="Selenium" href="http://www.seleniumhq.org/" target="_blank">Selenium</a> or <a title="CodedUI" href="https://msdn.microsoft.com/en-us/library/dd286681%28v=vs.100%29.aspx" target="_blank">CodedUI</a> tests. As you may know, UI tests are more fragile, harder and slower to execute than unit tests and therefore we execute them less. UI tests are good in some cases but if we could replace them with a more reliable suite of tests, that would be great.</p>
<p>And here is where <a title="RazorGenerator extension" href="https://visualstudiogallery.msdn.microsoft.com/1f6ec6ff-e89b-4c47-8e79-d2d68df894ec?SRC=VSIDE" target="_blank">RazorGenerator</a> extension and <a title="NuGet" href="https://www.nuget.org/" target="_blank">NuGet</a> packages (created by <a title="David Ebbo" href="https://twitter.com/davidebbo" target="_blank">David Ebbo</a>) come to rescue. What does this extension? It pre-compiles locally your views (the same code that is generated by IIS when you load a page is generated locally) so mainly you win three things:</p>
<ul>
<li>The initial loading of your website will be faster because the view is already compiled.</li>
<li>You can test your views.</li>
<li>You don't need to deploy your cshtml files.</li>
</ul>
<p>The first step is to install the extension, so go to the Extensions and Updates section of <a title="Visual Studio" href="http://www.visualstudio.com/" target="_blank">Visual Studio</a> and search for <a title="RazorGenerator extension" href="https://visualstudiogallery.msdn.microsoft.com/1f6ec6ff-e89b-4c47-8e79-d2d68df894ec?SRC=VSIDE" target="_blank">RazorGenerator</a>.</p>
<p>[caption id="attachment_219" align="alignnone" width="1024"]<a href="http://vgaltes.com/wp-content/uploads/2015/01/1.png"><img class="size-large wp-image-219" src="http://vgaltes.com/wp-content/uploads/2015/01/1-1024x709.png" alt="RazorGenerator extension" width="1024" height="709" /></a> RazorGenerator extension[/caption]</p>
<p>With the extension installed you are already able to pre-compile your views, but if you want to use them in your site, you should install <a title="RazorGenerator.Mvc" href="https://www.nuget.org/packages/RazorGenerator.Mvc/" target="_blank">RazorGenerator.Mvc</a> NuGet package in your web project.</p>
<p>To generate the code version of your view you must set RazorGenerator as the custom tool of the views.</p>
<p>[caption id="attachment_220" align="alignnone" width="1023"]<a href="http://vgaltes.com/wp-content/uploads/2015/01/2.png"><img class="size-full wp-image-220" src="http://vgaltes.com/wp-content/uploads/2015/01/2.png" alt="RazorGenerator custom tool" width="1023" height="386" /></a> RazorGenerator custom tool[/caption]</p>
<p>And that's all. The extension you've just installed will generate the compiled version of the view.</p>
<p>[caption id="attachment_221" align="alignnone" width="379"]<a href="http://vgaltes.com/wp-content/uploads/2015/01/3.png"><img class="size-full wp-image-221" src="http://vgaltes.com/wp-content/uploads/2015/01/3.png" alt="Pre-compiled view" width="379" height="136" /></a> Pre-compiled view[/caption]</p>
<p>Now you have a code version of your view, so you can test it. Go to your test project and install the <a title="RazorGenerator.Testing" href="https://www.nuget.org/packages/RazorGenerator.Testing/" target="_blank">RazorGenerator.Testing</a> package. A typical test could be this one:</p>
<pre class="brush:csharp">[TestMethod]
public void TestUsingRoutes()
{
    // Instantiate the view directly
    var view = new UsingRoutes();

    // Set up the data that needs to be access by the view
    MvcApplication.RegisterRoutes(RouteTable.Routes);

    // Render it in an HtmlDocument
    var output = view.RenderAsHtml();

    // Verify that it looks correct
    var element = output.GetElementbyId("link-using-routes");
    Assert.AreEqual("/Home/UsingRoutes", element.Attributes["href"].Value);
}</pre>
<p>Where UsingRoutes is the name of the view we want to test. As you can see, the package provides us with an extension method for the view called RenderAsHtml (and another one called RenderAsString). This method returns an HtmlNode object of the <a title="HtmlAgilityPack" href="http://htmlagilitypack.codeplex.com/" target="_blank">HtmlAgilityPack</a> library that we can query easily to verify if the view is correctly rendered.</p>
<p>It's possible that you will need to setup an <a title="HttpContext" href="https://msdn.microsoft.com/en-us/library/system.web.httpcontext%28v=vs.110%29.aspx" target="_blank">HttpContext</a> object (using mocks) to simulate some behavior. The library provides us a simple builder called <a title="HttpContextBuilder" href="http://razorgenerator.codeplex.com/SourceControl/latest#RazorGenerator.Testing/HttpContextBuilder.cs" target="_blank">HttpContextBuilder</a> that you can use for this purpose. Let's see an example:</p>
<pre class="brush:csharp">[TestMethod]
public void TestMockHttpContext()
{
    // Instantiate the view directly
    var view = new MockHttpContext();

    // Set up the data that needs to be access by the view
    var mockHttpRequest = new Mock&lt;HttpRequestBase&gt;(MockBehavior.Loose);
    mockHttpRequest.Setup(m =&gt; m.IsAuthenticated).Returns(true);

    // Render it in an HtmlDocument
    var output = view.RenderAsHtml(new HttpContextBuilder().With(mockHttpRequest.Object).Build());

    // Verify that it looks correct
    var element = output.GetElementbyId("user-authenticated");
    Assert.IsNotNull(element);   
}</pre>
<p>As you can see we are setting up a mock of the <a title="HttpRequest" href="https://msdn.microsoft.com/en-us/library/system.web.httprequest%28v=vs.110%29.aspx" target="_blank">HttpRequest</a> object to specify that the user is authenticated. We can pass an HttpContext created with the builder as the first parameter of the RenderAsHtml call.</p>
<p>And that's all. Testing is not the main purpose of <a title="RazorGenerator" href="http://razorgenerator.codeplex.com/" target="_blank">RazorGenerator</a> project, but it's a nice side effect.</p>
